# Story 1.1 – Webhook de WhatsApp (validación y parsing)

## Status: Draft

## Story
Como servicio de mensajería de migue.ai,
Quiero recibir eventos de WhatsApp de forma segura y normalizada,
Para poder persistir mensajes y orquestar respuestas con baja latencia.

## Contexto (fuentes)
- PRD: `docs/prd/section-requisitos-apis.md` (RF1, APIs)
- Arquitectura: `docs/architecture.md` (Endpoints 3, Flujos 2)

## Aceptación
1. El endpoint `POST /api/whatsapp/webhook` valida firma/token y rechaza payloads inválidos con 401/400.
2. Mensajes entrantes se normalizan (texto/media básicos) y se persisten (`users`, `conversations`, `messages`).
3. Se registra `request_id` y logs mínimos (sin PII) por solicitud.
4. p95 de respuesta < 2s para mensajes de texto (sin IA en esta historia).
5. Tests unitarios/integración cubren caminos feliz y error (token inválido, payload malformado).

## Dev Notes (resumen técnico)
- Edge Function: `api/whatsapp/webhook` (Vercel Edge).
- Validación: verify token (GET) y firma/HMAC si aplica (headers Meta).
- Normalización: extraer `from`, `type`, `text`/`media_url`, `wa_message_id`, `timestamp`.
- Persistencia: upsert `users` por `phone_number`; crear/obtener `conversations`; insertar `messages` (direction=inbound).
- Logs: JSON con `request_id`, duración, resultado; no PII/secretos.
- Seguridad: sanitización entradas, límites de tamaño, 4xx/5xx claros.

## Endpoints afectados
- `POST /api/whatsapp/webhook` (nuevo)

## Esquema de datos usado
- `users(id, phone_number unique, …)`
- `conversations(id, user_id fk, …)`
- `messages(id, conversation_id fk, direction, type, content, media_url, wa_message_id, timestamp, created_at)`

## Tareas / Subtareas
- [ ] Crear ruta Edge `api/whatsapp/webhook` (POST y verificación GET)
  - [ ] Implementar verificación token (GET challenge)
  - [ ] Validar firma/HMAC (si header disponible)
  - [ ] Parse/normalizar payload (texto/media básico)
- [ ] Persistencia en Supabase
  - [ ] Upsert `users` por `phone_number`
  - [ ] Obtener/crear `conversations`
  - [ ] Insert `messages` inbound con metadatos
- [ ] Logging y errores
  - [ ] Generar `request_id` y logs estructurados
  - [ ] Respuestas 2xx/4xx/5xx consistentes
- [ ] Tests
  - [ ] Unit: validación token/firma, parser
  - [ ] Integración: inserciones en tablas con payloads de ejemplo
- [ ] Observabilidad
  - [ ] Métricas básicas (duración, conteo por tipo)

## Riesgos
- Cambios en formato de Webhook de Meta
- Payloads grandes o media no soportada en MVP

## Notas de implementación
- Mantener la lógica de IA fuera de esta historia (solo recepción/persistencia). Añadir IA en 1.4.
- Documentar ejemplos de request/response en OpenAPI inicial.
